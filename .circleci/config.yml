version: 2.1

executors:
  ubuntu:
    machine:
      image: ubuntu-2204:2022.10.2
      docker_layer_caching: true
      resource_class: medium
  chelmsford:
    docker:
      - image: naiama/chelmsford:0.1.0
    resource_class: medium

jobs:
  build-test-push:
    description: Build image from Dockerfile, test, and push to Naiama DockerHub
    parameters:
      img-name:
        description: Image name
        type: string
      img-version:
        description: Image version
        type: string
    parallelism: 2
    executor:
      name: ubuntu
    steps:
      - checkout
      - run:
          name: Build
          command: |
            echo 'export IMG_NAME="naiama/<< parameters.img-name >>:<< parameters.img-version>>"' >> "$BASH_ENV"
            docker login -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_ACCESS_TOKEN"
            docker build -t $IMG_NAME -f << parameters.img-name >>/Dockerfile << parameters.img-name >>
      - run:
          name: Test
          working_directory: << parameters.img-name >>/test
          command: |
            source "$BASH_ENV"
            echo "$IMG_NAME"
            go mod init << parameters.img-name >>
            go mod tidy
            go test -v -timeout 30m -args -imgName=$IMG_NAME
      - run:
          name: Push
          command: |
            docker push $IMG_NAME

workflows:
  build-images:
    jobs:
      - build-test-push:
          context: docker-auth
          img-name: elland
          img-version: 0.1.2
          
      - build-test-push:
          context: docker-auth
          img-name: longor
          img-version: 0.1.0
